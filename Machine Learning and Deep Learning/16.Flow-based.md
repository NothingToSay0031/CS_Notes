# Flow-based Generative Model

## Flow-based Generative Model

### Generative Models

- Component-by-component (Auto-regressive Model)
  - What is the best order for the components?
  - Slow generation

- Variational Auto-encoder
  - Optimizing a lower bound (of likelihood)

- Generative Adversarial Network
  - Unstable training

### Generator

A generator G is a network. The network defines a probability distribution $p_G$

<center><img src="ML2020.assets/image-20210223110921790.png" width="60%"/></center>

Flow-based model directly optimizes the objective function.

### Math Background

#### Jacobian Matrix

$$
\begin{array}{ll}
z=\left[\begin{array}{l}
z_{1} \\
z_{2}
\end{array}\right] \quad x=\left[\begin{array}{l}
x_{1} \\
x_{2}
\end{array}\right] \\
x=f(z) \quad z=f^{-1}(x)
\end{array}\\J_{f}=\overbrace{\left[\begin{array}{cc} 
\partial x_{1} / \partial z_{1} & \partial x_{1} / \partial z_{2} \\
\partial x_{2} / \partial z_{1} & \partial x_{2} / \partial z_{2}
\end{array}\right] }^{\text {input }}   \  \text { output }
\\J_{f^{-1}}=\left[\begin{array}{cc}
\partial z_{1} / \partial x_{1} & \partial z_{1} / \partial x_{2} \\
\partial z_{2} / \partial x_{1} & \partial z_{2} / \partial x_{2}
\end{array}\right]\\
J_{f} J_{f^{-1}}=I
$$

Demo
$$
\begin{array}{c}
{\left[\begin{array}{c}
x_{1} \\
x_{2}
\end{array}\right]} =
{\left[\begin{array}{c}
z_{1}+z_{2} \\
2 z_{1}
\end{array}\right]=f\left(\left[\begin{array}{c}
z_{1} \\
z_{2}
\end{array}\right]\right)} \\
{\left[\begin{array}{c}
z_{1} \\
z_{2}
\end{array}\right]} =
{\left[\begin{array}{c}
x_{2} / 2 \\
x_{1}-x_{2} / 2
\end{array}\right]=f^{-1}\left(\left[\begin{array}{c}
x_{1} \\
x_{2}
\end{array}\right]\right)} \\
J_{f}=\left[\begin{array}{cc}
1 & 1 \\
2 & 0
\end{array}\right] \\
J_{f^{-1}}=\left[\begin{array}{cc}
0 & 1 / 2 \\
1 & -1 / 2
\end{array}\right]
\end{array}
$$

#### Determinant

The determinant of a **square matrix** is a **scalar** that provides information about the matrix.

<center><img src="ML2020.assets/image-20210223114144905.png" width="60%"/></center>

é«˜ç»´ç©ºé—´ä¸­çš„ä½“ç§¯çš„æ¦‚å¿µ

<center><img src="ML2020.assets/image-20210223114404629.png" width="60%"/></center>

#### Change of Variable Theorem

<center><img src="ML2020.assets/image-20210223114529060.png" width="60%"/></center>

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç»™å®šä¸¤ç»„æ•°æ®$z$å’Œ$x$ï¼Œå…¶ä¸­zæœä»å·²çŸ¥çš„ç®€å•å…ˆéªŒåˆ†å¸ƒ$Ï€(z)$ï¼ˆé€šå¸¸æ˜¯é«˜æ–¯åˆ†å¸ƒï¼‰ï¼Œ$x$æœä»å¤æ‚çš„åˆ†å¸ƒ$p(x)$ï¼ˆå³è®­ç»ƒæ•°æ®ä»£è¡¨çš„åˆ†å¸ƒï¼‰ï¼Œç°åœ¨æˆ‘ä»¬æƒ³è¦æ‰¾åˆ°ä¸€ä¸ªå˜æ¢å‡½æ•°$f$ï¼Œå®ƒèƒ½å»ºç«‹ä¸€ç§zåˆ°xçš„æ˜ å°„ï¼Œä½¿å¾—æ¯å¯¹äº$Ï€(z)$ä¸­çš„ä¸€ä¸ªé‡‡æ ·ç‚¹ï¼Œéƒ½èƒ½åœ¨$p(x)$ä¸­æœ‰ä¸€ä¸ªï¼ˆæ–°ï¼‰æ ·æœ¬ç‚¹ä¸ä¹‹å¯¹åº”ã€‚

å¦‚æœè¿™ä¸ªå˜æ¢å‡½æ•°èƒ½æ‰¾åˆ°çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªç”Ÿæˆæ¨¡å‹çš„æ„é€ ã€‚å› ä¸ºï¼Œ$p(x)$ä¸­çš„æ¯ä¸€ä¸ªæ ·æœ¬ç‚¹éƒ½ä»£è¡¨ä¸€å¼ å…·ä½“çš„å›¾ç‰‡ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›æœºå™¨ç”»å‡ºæ–°å›¾ç‰‡çš„è¯ï¼Œåªéœ€è¦ä»$Ï€(z)$ä¸­éšæœºé‡‡æ ·ä¸€ä¸ªç‚¹ï¼Œç„¶åé€šè¿‡æ˜ å°„ï¼Œå¾—åˆ°æ–°æ ·æœ¬ç‚¹ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”çš„ç”Ÿæˆçš„å…·ä½“å›¾ç‰‡ã€‚

æ¥ä¸‹æ¥çš„å…³é”®åœ¨äºï¼Œè¿™ä¸ªå˜æ¢å‡½æ•°få¦‚ä½•æ‰¾å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­ã€‚

<center><img src="ML2020.assets/image-20210223121433856.png" width="60%"/></center>

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‡è®¾zå’Œxéƒ½æ˜¯ä¸€ç»´åˆ†å¸ƒï¼Œå…¶ä¸­zæ»¡è¶³ç®€å•çš„å‡åŒ€åˆ†å¸ƒï¼š$\pi(z)=1(z \in[0,1])$ï¼Œxä¹Ÿæ»¡è¶³ç®€å•å‡åŒ€åˆ†å¸ƒï¼š$p(x)=0.5(x \in[1,3])$ã€‚

é‚£ä¹ˆæ„å»ºzä¸xä¹‹é—´çš„å˜æ¢å…³ç³»åªéœ€è¦æ„é€ ä¸€ä¸ªçº¿æ€§å‡½æ•°å³å¯ï¼š$x=f(z)=2z+1$ã€‚

ä¸‹é¢å†è€ƒè™‘éå‡åŒ€åˆ†å¸ƒçš„æ›´å¤æ‚çš„æƒ…å†µ

<center><img src="ML2020.assets/image-20210223122134111.png" width="60%"/></center>

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ$Ï€(z)$ä¸$p(x)$éƒ½æ˜¯è¾ƒä¸ºå¤æ‚çš„åˆ†å¸ƒï¼Œä¸ºäº†å®ç°äºŒè€…çš„è½¬åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘åœ¨å¾ˆçŸ­çš„é—´éš”ä¸Šå°†äºŒè€…è§†ä¸ºç®€å•å‡åŒ€åˆ†å¸ƒï¼Œç„¶ååº”ç”¨å‰è¾¹æ–¹æ³•è®¡ç®—å°æ®µä¸Šçš„ï¼Œæœ€åå°†æ¯ä¸ªå°æ®µå˜æ¢ç´¯åŠ èµ·æ¥ï¼ˆæ¯ä¸ªå°æ®µå®é™…å¯¹åº”ä¸€ä¸ªé‡‡æ ·æ ·æœ¬ï¼‰å°±å¾—åˆ°æœ€ç»ˆçš„å®Œæ•´å˜æ¢å¼$f$ã€‚

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‡è®¾åœ¨$[ğ‘§',ğ‘§'+âˆ†ğ‘§]$ä¸Š$Ï€(z)$è¿‘ä¼¼æœä»å‡åŒ€åˆ†å¸ƒï¼Œåœ¨$[x',x'+âˆ†x]$ä¸Š$p(x)$ä¹Ÿè¿‘ä¼¼æœä»å‡åŒ€åˆ†å¸ƒï¼Œäºæ˜¯æœ‰$ğ‘(ğ‘¥')âˆ†ğ‘¥=ğœ‹(ğ‘§')âˆ†ğ‘§$ï¼ˆå› ä¸ºå˜æ¢å‰åçš„é¢ç§¯/å³é‡‡æ ·æ¦‚ç‡æ˜¯ä¸€è‡´çš„ï¼‰ï¼Œå½“$âˆ†x$ä¸$âˆ†ğ‘§$æå°æ—¶ï¼Œæœ‰ï¼š
$$
ğ‘(ğ‘¥')=ğœ‹(ğ‘§')\lvert\frac{ğ‘‘ğ‘§}{ğ‘‘ğ‘¥}\rvert
$$
åˆè€ƒè™‘åˆ°$\frac{ğ‘‘ğ‘§}{ğ‘‘ğ‘¥}$æœ‰å¯èƒ½æ˜¯è´Ÿå€¼ï¼Œè€Œ$ğ‘(ğ‘¥')ã€ğœ‹(ğ‘§')$éƒ½ä¸ºéè´Ÿï¼Œæ‰€ä»¥çš„å®é™…å…³ç³»éœ€è¦åŠ ä¸Šç»å¯¹å€¼

è¿›ä¸€æ­¥åœ°åšæ¨å¹¿ï¼Œæˆ‘ä»¬è€ƒè™‘zä¸xéƒ½æ˜¯äºŒç»´åˆ†å¸ƒçš„æƒ…å½¢ã€‚

<center><img src="ML2020.assets/image-20210223162932650.png" width="60%"/></center>

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œzä¸xéƒ½æ˜¯äºŒç»´åˆ†å¸ƒï¼Œå·¦å›¾ä¸­æµ…è“è‰²åŒºåŸŸè¡¨ç¤ºåˆå§‹ç‚¹åœ¨$z_1$æ–¹å‘ä¸Šç§»åŠ¨$Î”z_1$ï¼Œåœ¨$z_2$æ–¹å‘ä¸Šç§»åŠ¨$Î”z_2$æ‰€å½¢æˆçš„åŒºåŸŸï¼Œè¿™ä¸€åŒºåŸŸé€šè¿‡æ˜ å°„ï¼Œå½¢æˆxåŸŸä¸Šçš„æµ…ç»¿è‰²è±å½¢åŒºåŸŸã€‚å…¶ä¸­ï¼ŒäºŒç»´åˆ†å¸ƒ$Ï€(z)$ä¸$p(x)$å‡æœä»ç®€å•å‡åŒ€åˆ†å¸ƒï¼Œå…¶é«˜åº¦åœ¨å›¾ä¸­æœªç”»å‡ºï¼ˆå‚ç›´çº¸é¢å‘å¤–ï¼‰ã€‚$Î”x_{11}$ä»£è¡¨$z_1$æ”¹å˜æ—¶ï¼Œ$x_1$æ”¹å˜é‡ï¼›$Î”x_{21}$æ˜¯$z_1$æ”¹å˜æ—¶ï¼Œ$x_2$æ”¹å˜é‡ã€‚$Î”x_{12}$ä»£è¡¨$z_2$æ”¹å˜æ—¶ï¼Œ$x_1$æ”¹å˜é‡ï¼›$Î”x_{22}$æ˜¯$z_2$æ”¹å˜æ—¶ï¼Œ$x_2$æ”¹å˜é‡.

å› ä¸ºè“è‰²åŒºåŸŸä¸ç»¿è‰²åŒºåŸŸå…·æœ‰ç›¸åŒçš„ä½“ç§¯ï¼Œæ‰€ä»¥æœ‰ï¼š
$$
p\left(x^{\prime}\right)\left|\operatorname{det}\left[\begin{array}{ll}\Delta x_{11} & \Delta x_{21} \\ \Delta x_{12} & \Delta x_{22}\end{array}\right]\right|=\pi\left(z^{\prime}\right) \Delta z_{1} \Delta z_{2} \quad x=f(z)
$$
 å…¶ä¸­$\operatorname{det}\left[\begin{array}{ll}\Delta x_{11} & \Delta x_{21} \\ \Delta x_{12} & \Delta x_{22}\end{array}\right]$ä»£è¡¨è¡Œåˆ—å¼è®¡ç®—ï¼Œå®ƒçš„è®¡ç®—ç»“æœç­‰äºä¸Šå›¾ä¸­æµ…ç»¿è‰²åŒºåŸŸçš„é¢ç§¯ï¼ˆè¡Œåˆ—å¼çš„å®šä¹‰ï¼‰ã€‚ä¸‹é¢æˆ‘ä»¬å°†ç§»$\Delta z_{1} \Delta z_{2}$è‡³å·¦ä¾§ï¼Œå¾—åˆ°ï¼š
$$
p\left(x^{\prime}\right)\left|\frac{1}{\Delta z_{1} \Delta z_{2}} \operatorname{det}\left[\begin{array}{ll}\Delta x_{11} & \Delta x_{21} \\ \Delta x_{12} & \Delta x_{22}\end{array}\right]\right|=\pi\left(z^{\prime}\right)
$$
å³å¯å¾—åˆ°
$$
p\left(x^{\prime}\right)\left|\operatorname{det}\left[\begin{array}{ll}\Delta x_{11} / \Delta z_{1} & \Delta x_{21} / \Delta z_{1} \\ \Delta x_{12} / \Delta z_{2} & \Delta x_{22} / \Delta z_{2}\end{array}\right]\right|=\pi\left(z^{\prime}\right)
$$
å½“å˜åŒ–å¾ˆå°æ—¶
$$
p\left(x^{\prime}\right)\left|\operatorname{det}\left[\begin{array}{ll}\partial x_{1} / \partial z_{1} & \partial x_{2} / \partial z_{1} \\ \partial x_{1} / \partial z_{2} & \partial x_{2} / \partial z_{2}\end{array}\right]\right|=\pi\left(z^{\prime}\right)
$$
åšè½¬ç½®ï¼Œè½¬ç½®ä¸ä¼šæ”¹å˜è¡Œåˆ—å¼
$$
p\left(x^{\prime}\right)\left|\operatorname{det}\left[\begin{array}{l}\partial x_{1} / \partial z_{1} & \partial x_{1} / \partial z_{2} \\ \partial x_{2} / \partial z_{1} & \partial x_{2} / \partial z_{2}\end{array}\right]\right|=\pi\left(z^{\prime}\right)
$$
å°±å¾—åˆ°
$$
p\left(x^{\prime}\right)\left|\operatorname{det}\left(J_{f}\right)\right|=\pi\left(z^{\prime}\right)
$$
æ ¹æ®é›…å„æ¯”è¡Œåˆ—å¼çš„é€†è¿ç®—ï¼Œå¾—åˆ°
$$
p\left(x^{\prime}\right)=\pi\left(z^{\prime}\right)\left|\frac{1}{\operatorname{det}\left(J_{f}\right)}\right| =\pi\left(z^{\prime}\right)\left|\operatorname{det}\left(J_{f^{-1}}\right)\right|
$$
 è‡³æ­¤ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„ç»“è®ºï¼šå¦‚æœ$z$ä¸$x$åˆ†åˆ«æ»¡è¶³ä¸¤ç§åˆ†å¸ƒï¼Œå¹¶ä¸”$z$é€šè¿‡å‡½æ•°$f$èƒ½å¤Ÿè½¬å˜ä¸º$x$ï¼Œé‚£ä¹ˆ$z$ä¸$x$ä¸­çš„ä»»æ„ä¸€ç»„å¯¹åº”é‡‡æ ·ç‚¹$z'$ä¸$x'$ä¹‹é—´çš„å…³ç³»ä¸ºï¼š
$$
\left\{\begin{array}{l}\pi\left(z^{\prime}\right)=p\left(x^{\prime}\right)\left|\operatorname{det}\left(J_{f}\right)\right| \\ p\left(x^{\prime}\right)=\pi\left(z^{\prime}\right)\left|\operatorname{det}\left(J_{f^{-1}}\right)\right|\end{array}\right.
$$

### Formal Explanation

é‚£ä¹ˆåŸºäºè¿™ä¸€ç»“è®ºï¼Œå†å¸¦å›åˆ°ç”Ÿæˆæ¨¡å‹è¦è§£å†³çš„é—®é¢˜å½“ä¸­ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†Flow-based Modelï¼ˆæµæ¨¡å‹ï¼‰çš„åˆæ­¥å»ºæ¨¡æ€ç»´ã€‚

<center><img src="ML2020.assets/image-20210223171646781.png" width="60%"/></center>

ä¸Šå›¾æ‰€ç¤ºï¼Œä¸ºäº†å®ç° ${z} \sim \pi({z})$ åˆ° $x=G(z) \sim p_{G}({x})$ é—´çš„è½¬åŒ–ï¼Œå¾…æ±‚è§£çš„ç”Ÿæˆå™¨Gçš„è¡¨è¾¾å¼ä¸ºï¼š
$$
G^{*}=\arg \max _{G} \sum_{i=1}^{m} \log p_{G}\left(x^{i}\right)
$$
åŸºäºå‰é¢æ¨å¯¼, æˆ‘ä»¬æœ‰ $p_{c}({x})$ ä¸­çš„æ ·æœ¬ç‚¹ä¸ $\pi({z})$ ä¸­çš„æ ·æœ¬ç‚¹é—´çš„å…³ç³»ä¸ºï¼š
$$
p_{G}\left(x^{i}\right)=\pi\left(z^{i}\right)\left|\operatorname{det}\left(J_{G^{-1}}\right)\right|
$$
å…¶ä¸­ $z^{i}=G^{-1}\left(x^{i}\right)$

æ‰€ä»¥ï¼Œå¦‚æœ$G^*$çš„ç›®æ ‡å¼èƒ½å¤Ÿé€šè¿‡ä¸Šè¿°å…³ç³»å¼æ±‚è§£å‡ºæ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„ç”Ÿæˆæ¨¡å‹çš„æ±‚è§£ã€‚

Flow-based Modelå°±æ˜¯åŸºäºè¿™ä¸€æ€ç»´è¿›è¡Œç†è®ºæ¨å¯¼å’Œæ¨¡å‹æ„å»ºï¼Œä¸‹é¢è¯¦ç»†è§£é‡ŠFlow-based Modelçš„æ±‚è§£è¿‡ç¨‹ã€‚

å°†ä¸Šè¿°å¼å­å–logï¼Œå¾—åˆ°
$$
\log p_{G}\left(x^{i}\right)=\log \pi\left(G^{-1}\left(x^{i}\right)\right)+\log \left|\operatorname{det}\left(J_{G^{-1}}\right)\right|
$$
ç°åœ¨ï¼Œå¦‚æœæƒ³ç›´æ¥maximizeæ±‚è§£è¿™ä¸ªå¼å­æœ‰ä¸¤æ–¹é¢çš„å›°éš¾ã€‚

ç¬¬ä¸€ä¸ªå›°éš¾æ˜¯$\operatorname{det}\left(J_{G^{-1}}\right)$æ˜¯ä¸å¥½è®¡ç®—çš„â€”â€”ç”±äº$G^{-1}$çš„JacobiançŸ©é˜µä¸€èˆ¬ç»´åº¦ä¸ä½ï¼ˆè­¬å¦‚256*256çŸ©é˜µï¼‰ï¼Œå…¶è¡Œåˆ—å¼çš„è®¡ç®—é‡æ˜¯å¼‚å¸¸å·¨å¤§çš„ï¼Œæ‰€ä»¥åœ¨å®é™…è®¡ç®—ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»å¯¹$G^{-1}$çš„Jacobianè¡Œåˆ—å¼åšä¸€å®šä¼˜åŒ–ï¼Œä½¿å…¶èƒ½å¤Ÿåœ¨è®¡ç®—ä¸Šå˜å¾—ç®€æ´é«˜æ•ˆã€‚

ç¬¬äºŒä¸ªå›°éš¾æ˜¯ï¼Œè¡¨è¾¾å¼ä¸­å‡ºç°äº†$G^{-1}$ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬è¦çŸ¥é“$G^{-1}$é•¿ä»€ä¹ˆæ ·å­ï¼Œè€Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ±‚$G$ï¼Œæ‰€ä»¥è¿™éœ€è¦å·§å¦™åœ°è®¾è®¡$G$çš„ç»“æ„ä½¿å¾—$G^{-1}$ä¹Ÿæ˜¯å¥½è®¡ç®—çš„ï¼ŒåŒæ—¶è¦æ±‚zå’Œxçš„dimensionæ˜¯ä¸€æ ·çš„æ‰èƒ½ä½¿$G^{-1}$å­˜åœ¨ã€‚

è¿™äº›è¦æ±‚ä½¿å¾—Gæœ‰å¾ˆå¤šé™åˆ¶ã€‚ç”±äºå•ä¸ªGå—åˆ°äº†è¾ƒå¤šçš„çº¦æŸï¼Œæ‰€ä»¥å¯èƒ½è¡¨å¾èƒ½åŠ›æœ‰é™ï¼Œå› æ­¤å¯ä»¥è¿›è¡Œå¤šå±‚æ‰©å±•ï¼Œå…¶å¯¹åº”çš„å…³ç³»å¼åªè¦è¿›è¡Œé€’æ¨ä¾¿å¯ã€‚

<center><img src="ML2020.assets/image-20210223173319320.png" width="60%"/></center>

### What you actually do?

ä¸‹é¢æˆ‘ä»¬æ¥é€æ­¥è®¾è®¡Gçš„ç»“æ„ï¼Œé¦–å…ˆä»æœ€åŸºæœ¬çš„æ¶æ„å¼€å§‹æ„æ€ã€‚è€ƒè™‘åˆ°$G^{-1}$å¿…é¡»æ˜¯å­˜åœ¨çš„ä¸”èƒ½è¢«ç®—å‡ºï¼Œè¿™æ„å‘³ç€Gçš„è¾“å…¥å’Œè¾“å‡ºçš„ç»´åº¦å¿…é¡»æ˜¯ä¸€è‡´çš„å¹¶ä¸”Gçš„è¡Œåˆ—å¼ä¸èƒ½ä¸º0ã€‚

ç„¶åï¼Œæ—¢ç„¶$G^{-1}$å¯ä»¥è®¡ç®—å‡ºæ¥ï¼Œè€Œ$\log p_{G}\left(x^{i}\right)$çš„ç›®æ ‡è¡¨è¾¾å¼åªä¸$G^{-1}$æœ‰å…³ï¼Œæ‰€ä»¥åœ¨å®é™…è®­ç»ƒä¸­æˆ‘ä»¬å¯ä»¥è®­$G^{-1}$å¯¹åº”çš„ç½‘ç»œï¼Œç„¶åæƒ³åŠæ³•ç®—å‡ºGæ¥ï¼Œå¹¶ä¸”åœ¨æµ‹è¯•æ—¶æ”¹ç”¨Gåšå›¾åƒç”Ÿæˆã€‚

<center><img src="ML2020.assets/image-20210223175247763.png" width="60%"/></center>

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨è®­ç»ƒæ—¶æˆ‘ä»¬ä»çœŸå®åˆ†å¸ƒ$p_{data}(x)$ä¸­é‡‡æ ·å‡º$x^{i}$ï¼Œç„¶åå»è®­ç»ƒ$G^{-1}$ï¼Œä½¿å¾—é€šè¿‡$G^{-1}$ç”Ÿæˆçš„æ»¡è¶³ç‰¹å®š$z^{i}=G^{-1}\left(x^{i}\right)$çš„å…ˆéªŒåˆ†å¸ƒï¼Œmaximizeä¸Šé¢çš„objective functionï¼Œè¿™é‡Œä¸€èˆ¬éœ€è¦ä¿è¯ $x^{i}$ å’Œ $z^{i}$ å…·æœ‰ç›¸åŒçš„å°ºå¯¸ï¼›æ¥ä¸‹æ¥åœ¨æµ‹è¯•æ—¶ï¼Œæˆ‘ä»¬ä»zä¸­é‡‡æ ·å‡ºä¸€ä¸ªç‚¹$z^{j}$ï¼Œç„¶åé€šè¿‡Gç”Ÿæˆçš„æ ·æœ¬$x^{j}=G \left(z^{j}\right)$å°±æ˜¯æ–°çš„ç”Ÿæˆå›¾åƒã€‚

ç”±äº$z^i$æ˜¯ç¬¦åˆNormal Distributionï¼Œç­‰äº0æ—¶$\pi\left(z^{i}\right)$æœ€å¤§ï¼Œå› æ­¤ç¬¬ä¸€é¡¹è®©$z^i$è¶‹å‘äº0ï¼Œç¬¬äºŒé¡¹åˆè®©$z^i$è¿œç¦»0ã€‚

### Coupling Layer

æ¥ä¸‹æ¥å¼€å§‹å…·ä½“è€ƒè™‘ G çš„å†…éƒ¨è®¾è®¡ï¼Œä¸ºäº†è®©$G_{-1}$å¯ä»¥è®¡ç®—å¹¶ä¸” G çš„ Jacobian è¡Œåˆ—å¼ä¹Ÿæ˜“äºè®¡ç®—ï¼ŒFlow-based Modelé‡‡ç”¨äº†ä¸€ç§ç§°ä¸ºè€¦åˆå±‚ï¼ˆCoupling Layerï¼‰çš„è®¾è®¡æ¥å®ç°ã€‚å…¶è¢«åº”ç”¨åœ¨[NICE](https://arxiv.org/abs/1410.8516)å’Œ[Real NVP](https://arxiv.org/abs/1605.08803)è¿™ä¸¤ç¯‡è®ºæ–‡å½“ä¸­ã€‚

æ•´ä¸ªæµç¨‹å¯ä»¥è¡¨è¿°ä¸º

å…ˆå°†è¾“å…¥$z$ æ‹†åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼ˆå¯ä»¥æ˜¯æŒ‰channelè¿›è¡Œæ‹†åˆ†ï¼Œä¹Ÿå¯ä»¥è¿˜æ˜¯æŒ‰ç…§pixelçš„locationè¿›è¡Œæ‹†åˆ†ï¼‰, å¯¹äºä¸Šé¢çš„éƒ¨åˆ† $z_{1}, \ldots, z_{d}$ ç›´æ¥copyå¾—åˆ°å¯¹åº”çš„output $x_{1}, \ldots, x_{d}$ï¼Œè€Œå¯¹äºä¸‹é¢çš„åˆ†æ”¯åˆ™æœ‰å¦‚ä¸‹çš„å˜æ¢ï¼ˆå…¬å¼ä¸­ç¬¦å·ä»£è¡¨element-wiseç›¸ä¹˜ï¼‰
$$
\left(z_{d+1}, \ldots, z_{D}\right) \odot F\left(z_{1}, \ldots, z_{d}\right)+H\left(z_{1}, \ldots, z_{d}\right)=x_{d+1}, \ldots, x_{D},
$$
å¯ä»¥ç®€åŒ–ä¸ºï¼š$\left(z_{d+1}, \ldots, z_{D}\right) \odot\left(\beta_{1}, \ldots, \beta_{d}\right)+\left(\gamma_{1}, \ldots, \gamma_{d}\right)=x_{d+1}, \ldots, x_{D}$ æˆ–$\beta_{i} z_{i}+\gamma_{i}=x_{i>d}$ ã€‚

ä¹‹æ‰€ä»¥é‡‡ç”¨ä»¥ä¸Šè®¾è®¡ç»“æ„çš„åŸå› åœ¨äºä¸Šè¿°çš„ç»“æ„å®¹æ˜“è¿›è¡Œé€†è¿ç®—ã€‚

<center><img src="ML2020.assets/image-20210223181808200.png" width="60%"/></center>

#### Inverse

$z, x$ éƒ½è¢«åˆ†æˆä¸¤éƒ¨åˆ†, å‰ $d$ ç»´ç›´æ¥copyï¼Œå› æ­¤æ±‚é€†ä¹Ÿæ˜¯ç›´æ¥copyã€‚

å$D-d$ç»´ä½¿ç”¨ä¸¤ä¸ªå‡½æ•°è¿›è¡Œä»¿å°„å˜åŒ–ï¼Œå¯ä»¥å°† $x_{i>d}; z_{i>d}$ ä¹‹é—´çœ‹ä½œçº¿æ€§å…³ç³»ï¼Œå› æ­¤æ±‚é€†æ—¶ç›´æ¥è¿›è¡Œåæ“ä½œå³å¯ã€‚ 

$F, H$ å¯ä»¥æ˜¯ä»»æ„å¤æ‚çš„å‡½æ•°ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦æ±‚ä»–çš„é€†ã€‚åœ¨é€†å‘è¿‡ç¨‹ä¸­ï¼Œå®¹æ˜“å¾—åˆ° $z_{i \leq d}=x_{i}$ å’Œ $z_{i>d}=\frac{x_{i}-\gamma_{i}}{\beta_{i}}$ ã€‚

<center><img src="ML2020.assets/image-20210223182351393.png" width="60%"/></center>

è§£å†³å®Œ $G^{-1}$ éƒ¨åˆ†ï¼Œè¿˜éœ€è¦æ±‚è§£ç”Ÿæˆå™¨å¯¹åº”çš„é›…å¯æ¯”çŸ©é˜µ $J_{G}$ çš„è¡Œåˆ—å¼

#### Jacobian

<center><img src="ML2020.assets/image-20210223183713781.png" width="60%"/></center>

æˆ‘ä»¬ä»¬å¯ä»¥å°†ç”Ÿæˆå™¨å¯¹åº”çš„é›…å…‹æ¯”çŸ©é˜µåˆ†ä¸ºä»¥ä¸Šçš„å››ä¸ªå­å—, å·¦ä¸Šè§’ç”±äºæ˜¯ç›´æ¥copyçš„ï¼Œæ‰€ä»¥å¯¹åº”çš„éƒ¨åˆ†åº”è¯¥æ˜¯ä¸€ä¸ªå•ä½çŸ©é˜µï¼Œå³ä¸Šè§’ä¸­ç”±äº $x_{1}, \ldots, x_{d}$ ä¸ $z_{d+1}, \ldots, z_{D}$ æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ªé›¶çŸ©é˜µï¼Œè€Œå·¦ä¸‹è§’We don't careï¼Œå› ä¸ºè¡Œåˆ—å¼çš„å³ä¸Šè§’ä¸º0ï¼Œæ‰€ä»¥åªéœ€è¦æ±‚è§£ä¸»å¯¹è§’çº¿ä¸Šçš„å€¼å³å¯ã€‚

å³ä¸‹è§’ç”±äº$x_{i}=\beta_{i} z_{i}ï¼Œi>d$ï¼Œæ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œå› æ­¤æ˜¯å¯¹è§’é˜µï¼Œå¯¹è§’çº¿ä¸Šçš„å…ƒç´ åˆ†åˆ«ä¸º $\beta_{d+1}, \ldots, \beta_{D}$ ã€‚

æ‰€ä»¥ä¸Šè¿°çš„ $\left|\operatorname{det}\left(J_{G}\right)\right|=\left|\beta_{d+1} \beta_{d+2} \cdots \beta_{D}\right|$ ã€‚

é‚£ä¹ˆè¿™ä¹ˆä¸€æ¥coupling layerçš„è®¾è®¡æŠŠ $G^{-1}$ å’Œ $\operatorname{det}\left(J_{G}\right)$è¿™ä¸ªé—®é¢˜éƒ½è§£å†³äº†â€‹

#### Stacking

æˆ‘ä»¬å°†å¤šä¸ªè€¦åˆå±‚å †å åœ¨ä¸€èµ·ï¼Œä»è€Œå½¢æˆä¸€ä¸ªæ›´å®Œæ•´çš„ç”Ÿæˆå™¨ã€‚ä½†æ˜¯è¿™æ ·ä¼šæœ‰ä¸€ä¸ªæ–°é—®é¢˜ï¼Œå°±æ˜¯æœ€ç»ˆç”Ÿæˆæ•°æ®çš„å‰ d ç»´ä¸åˆå§‹æ•°æ®çš„å‰d ç»´æ˜¯ä¸€è‡´çš„ï¼Œè¿™ä¼šå¯¼è‡´ç”Ÿæˆæ•°æ®ä¸­æ€»æœ‰ä¸€ç‰‡åŒºåŸŸçœ‹èµ·æ¥åƒæ˜¯å›ºå®šçš„å›¾æ ·ï¼ˆå®é™…ä¸Šå®ƒä»£è¡¨ç€æ¥è‡ªåˆå§‹é«˜æ–¯å™ªéŸ³çš„ä¸€ä¸ªéƒ¨åˆ†ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å¤åˆ¶æ¨¡å—ï¼ˆcopyï¼‰ä¸ä»¿å°„æ¨¡å—ï¼ˆaffineï¼‰äº¤æ¢é¡ºåºçš„æ–¹å¼å»è§£å†³è¿™ä¸€é—®é¢˜ã€‚

<center><img src="ML2020.assets/image-20210223183955130.png" width="60%"/></center>

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œé€šè¿‡å°†æŸäº›è€¦åˆå±‚çš„copyä¸affineæ¨¡å—è¿›è¡Œä½ç½®ä¸Šçš„äº’æ¢ï¼Œä½¿å¾—æ¯ä¸€éƒ¨åˆ†æ•°æ®éƒ½èƒ½èµ°å‘ copy->affine->copy->affine çš„äº¤æ›¿å˜æ¢é€šé“ï¼Œè¿™æ ·æœ€ç»ˆçš„ç”Ÿæˆå›¾åƒå°±ä¸ä¼šåŒ…å«å®Œå…¨copyè‡ªåˆå§‹å›¾åƒçš„éƒ¨åˆ†ã€‚å€¼å¾—è¯´æ˜çš„æ˜¯ï¼Œåœ¨å›¾åƒç”Ÿæˆå½“ä¸­ï¼Œè¿™ç§copyä¸affineæ¨¡å—äº’æ¢çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œä¸‹é¢ä¸¾ä¸¤ä¸ªä¾‹å­æ¥è¯´æ˜ï¼š

##### åƒç´ ç»´åº¦åˆ’åˆ†/é€šé“ç»´åº¦åˆ’åˆ†

<center><img src="ML2020.assets/image-20210223184343127.png" width="60%"/></center>

ä¸Šå›¾å±•ç¤ºäº†ä¸¤ç§æŒ‰ç…§ä¸åŒçš„æ•°æ®åˆ’åˆ†æ–¹å¼åš copy ä¸ affine çš„äº¤æ›¿å˜æ¢ã€‚å·¦å›¾ä»£è¡¨çš„æ˜¯åœ¨åƒç´ ç»´åº¦ä¸Šåšåˆ’åˆ†ï¼Œå³å°†æ¨ªçºµåæ ‡ä¹‹å’Œä¸ºå¶æ•°çš„åˆ’åˆ†ä¸ºä¸€ç±»ï¼Œå’Œä¸ºå¥‡æ•°çš„åˆ’åˆ†ä¸ºå¦å¤–ä¸€ç±»ï¼Œ ç„¶åä¸¤ç±»åˆ†åˆ«äº¤æ›¿åš copy å’Œ affine å˜æ¢ï¼ˆä¸¤ä¸¤äº¤æ›¿ï¼‰ï¼›å³å›¾ä»£è¡¨çš„æ˜¯åœ¨é€šé“ç»´åº¦ä¸Šåšåˆ’åˆ†ï¼Œ é€šå¸¸å›¾åƒä¼šæœ‰ä¸‰é€šé“ï¼Œé‚£ä¹ˆåœ¨æ¯ä¸€æ¬¡è€¦åˆå˜æ¢ä¸­æŒ‰é¡ºåºé€‰æ‹©ä¸€ä¸ªé€šé“åš copyï¼Œå…¶ä»–é€šé“åš affineï¼ˆä¸‰ä¸ªè½®æ¢äº¤æ›¿ï¼‰ï¼Œä»è€Œæœ€ç»ˆå˜æ¢å‡ºæˆ‘ä»¬éœ€è¦çš„ç”Ÿæˆå›¾å½¢å‡ºæ¥ã€‚

##### 1Ã—1 convolution layer

æ›´è¿›ä¸€æ­¥åœ°ï¼Œå¦‚ä½•è¿›è¡Œ copy å’Œ affine çš„å˜æ¢èƒ½å¤Ÿè®©ç”Ÿæˆæ¨¡å‹å­¦ä¹ åœ°æ›´å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯ä»¥ç”±æœºå™¨æ¥å­¦ä¹ çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼•å…¥ W çŸ©é˜µï¼Œå¸®æˆ‘ä»¬å†³å®šæŒ‰ä»€ä¹ˆæ ·çš„é¡ºåºåš copy å’Œ affine å˜æ¢ï¼Œè¿™ç§æ–¹æ³•å«åš 1Ã—1 convolutionï¼ˆè¢«ç”¨äºçŸ¥åçš„[GLOW](https://arxiv.org/abs/1807.03039)å½“ä¸­ï¼‰ã€‚

<center><img src="ML2020.assets/image-20210223193220463.png" width="60%"/></center>

$ğ‘Š$ can shuffle the channels. æ‰€ä»¥copyæ—¶å¯ä»¥åªcopyç¬¬ä¸€ä¸ªchannelï¼Œåæ­£1Ã—1 convolutionä¼šåœ¨é€‚å½“çš„æ—¶æœºå¯¹channelè¿›è¡Œå¯¹è°ƒã€‚

1Ã—1 convolution åªéœ€è¦è®©æœºå™¨å†³å®šåœ¨æ¯æ¬¡ä»¿å°„è®¡ç®—å‰å¯¹å›¾ç‰‡å“ªäº›åŒºåŸŸå®è¡Œåƒç´ å¯¹è°ƒï¼Œè€Œä¿æŒ copy å’Œ affine æ¨¡å— çš„é¡ºåºä¸å˜ï¼Œè¿™å®é™…ä¸Šå’Œå¯¹è°ƒ copy å’Œ affine æ¨¡å—é¡ºåºäº§ç”Ÿçš„æ•ˆæœæ˜¯ä¸€è‡´çš„ã€‚

æ¯”å¦‚å³ä¾§ä¸‰ä¸ªé€šé“åˆ†åˆ«æ˜¯1ï¼Œ2ï¼Œ3ï¼Œç»è¿‡ä¸€ä¸ª$W$çŸ©é˜µå°±ä¼šå˜æˆ3ï¼Œ1ï¼Œ2ï¼Œç›¸å½“äºå¯¹é€šé“è°ƒæ¢äº†é¡ºåºã€‚è€Œcoupling layerä¸è¦åŠ¨ï¼ŒåªcopyæŸå‡ ä¸ªchannelã€‚è‡³äºchannelå¦‚ä½•äº¤æ¢ï¼Œéœ€è¦æœºå™¨å­¦å‡ºæ¥ã€‚

$W$ä¹Ÿåœ¨$G$é‡Œé¢ï¼Œä¹Ÿéœ€è¦invertibleã€‚

<center><img src="ML2020.assets/image-20210223193317420.png" width="60%"/></center>

ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼Œå°†$W$å¼•å…¥flowæ¨¡å‹ä¹‹åï¼Œå¯¹äºåŸå§‹çš„Jacobianè¡Œåˆ—å¼çš„è®¡ç®—æ˜¯å¦ä¼šæœ‰å½±å“ã€‚

å¯¹äºæ¯ä¸€ä¸ª3\*3ç»´åˆ’åˆ†ä¸Šçš„ä»¿å°„æ“ä½œæ¥è¯´ï¼Œç”±$x=f(z)=W z$ï¼Œå¯ä»¥å¾—åˆ°Jacobianè¡Œåˆ—å¼çš„è®¡ç®—ç»“æœå°±æ˜¯$W$

ä»£å…¥åˆ°æ•´ä¸ªå«æœ‰d\*dä¸ª3*3ç»´çš„ä»¿å°„å˜æ¢çŸ©é˜µå½“ä¸­ï¼Œåªæœ‰å¯¹åº”ä½ç½®ç›¸åŒçš„æ—¶å€™æ‰ä¼šæœ‰æƒå€¼ï¼Œå¾—åˆ°æœ€ç»ˆçš„Jacobianè¡Œåˆ—å¼çš„è®¡ç®—ç»“æœå°±ä¸º$(\operatorname{det}(W))^{d \times d}$

<center><img src="ML2020.assets/image-20210223193730124.png" width="60%"/></center>

å› æ­¤ï¼Œå¼•å…¥1Ã—1 convolutionåçš„$G$çš„Jacobianè¡Œåˆ—å¼è®¡ç®—ä¾ç„¶éå¸¸ç®€å•ï¼Œæ‰€ä»¥å¼•å…¥1Ã—1 convolutionæ˜¯å¯å–çš„ï¼Œè¿™ä¹Ÿæ˜¯GLOWè¿™ç¯‡Paperæœ€æœ‰çªç ´å’Œåˆ›æ„çš„åœ°æ–¹ã€‚

### Demo of OpenAI

<center><img src="ML2020.assets/image-20210223194354309.png" width="60%"/></center>

<center><img src="ML2020.assets/image-20210223194418087.png" width="60%"/></center>

### To Learn More â€¦â€¦

Flow-based Modelå¯ä»¥ç”¨äºè¯­éŸ³åˆæˆ

<center><img src="ML2020.assets/image-20210223194514827.png" width="60%"/></center>

ç»¼ä¸Šï¼Œå…³äº Flow-based Model çš„ç†è®ºè®²è§£å’Œæ¶æ„åˆ†æå°±å…¨éƒ¨ç»“æŸäº†ï¼Œå®ƒé€šè¿‡å·§å¦™åœ°æ„é€ ä»¿å°„å˜æ¢çš„æ–¹å¼å®ç°ä¸åŒåˆ†å¸ƒé—´çš„æ‹Ÿåˆï¼Œå¹¶å®ç°äº†å¯é€†è®¡ç®—å’Œç®€åŒ–é›…å„æ¯”è¡Œåˆ—å¼è®¡ç®—çš„åŠŸèƒ½å’Œä¼˜ç‚¹ï¼Œæœ€ç»ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡å †å å¤šä¸ªè¿™æ ·çš„è€¦åˆå±‚å»æ‹Ÿåˆæ›´å¤æ‚çš„åˆ†å¸ƒå˜åŒ–ï¼Œä»è€Œè¾¾åˆ°ç”Ÿæˆæ¨¡å‹éœ€è¦çš„æ•ˆæœã€‚





